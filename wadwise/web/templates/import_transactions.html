{% extends 'base.html' %}
{% from 'widgets.html' import select_group %}

{% block content %}
<style>
    .card.ignored {
        background: #EEE;
    }
    .card.ok {
        background: #EFE;
    }

    form-aligned {
        align-items: center;
        line-height: 100%;
    }

    .card {
       padding: 0.4em;
    }
</style>

<form method="POST" data-preact="tranForm" action="{{ url_for('import_transactions_apply') }}" class="pure-form"></form>

<template id="accountSelector">
    {{ select_group('some', '---', env.account_groups) }}
</template>

<script type="module">
    import {hh as h, render, signal, computed, cloneElement, effect,
            initPreactData, registerPreactData, batch, hooks,
            node2component, idify, fieldModel, preventDefault,
            classNames} from '/static/js/preact-all.js';

    const {useState} = hooks;

    function wrapItem(item) {
        return {
            ...item,
            state: signal(item.state),
            dest: signal(item.dest),
            desc: signal(item.desc),
        }
    }

    const balance = {{ balance | tojson }}
    const transactions = signal(idify({{ transactions | tojson }}).map(wrapItem))
    const form_data = computed(() => JSON.stringify(transactions.value))

    const submit_ok = computed(() => {
        return !transactions.value.some(it => !it.state.value && !it.dest.value)
    })

    const total = computed(() => {
        let result = 0
        for(const it of transactions.value) {
            if (!it.state.value) {
                result += it.amount
            }
        }
        return result
    })

    function setSimilar(other) {
        batch(() => {
            for(const tr of transactions.value) {
                if (tr === other) {
                    continue
                }
                if (tr.key && tr.key == other.key) {
                    tr.dest.value = other.dest.value;
                    tr.desc.value = other.desc.value;
                }
            }
        })
    }

    function AccountSelector(props) {
        const [open, setOpen] = useState(false);
        const handleSelectFocus = () => setOpen(true);
        return h('select', {...props, onFocus: handleSelectFocus},
            open || props.value.value ? accountSelector.props.children : h('option', '---')
        )
    }

    function Transaction({trn}) {
        const [state_value, state_title] = trn.state.value ? [null, 'Include'] : ['seen', 'Exclude']

        return h('div',
            {'class': classNames({card: true, ignored: trn.state.value, ok: !trn.state.value && trn.dest.value})},
            h('form-aligned',
                h('label.no-margin', trn.type),
                h('div.date.aligned-right', trn.date_str),

                h('label.no-margin', trn.name),
                h('div.aligned-right', h('span', trn.amount.toFixed(2)), '\xA0', h('span.cur', trn.cur)),

                h('span.aligned-full', trn.category),
                h(AccountSelector, {'class': 'aligned-full', name: 'dest', ...fieldModel(trn.dest)}),
                h('input.aligned-full', {type: 'text', name: 'desc', ...fieldModel(trn.desc)}),
                h('div.aligned-full',
                    h('button.pure-button.button-secondary',
                      {onClick: preventDefault(() => setSimilar(trn)), disabled: !trn.dest.value}, 'Set similar'),
                    ' ',
                    h('button.pure-button.button-secondary',
                      {onClick:preventDefault(() => trn.state.value = state_value)}, state_title)
                ),
            ),
        )
    }

    function TransactionList() {
        return transactions.value.map((trn) => h(Transaction, {trn, key: trn.id}))
    }

    function tranForm() {
        return [
            h('input', {name: "src", value: {{ src | tojson }}, hidden: true}),
            h('input', {name: "transactions", value: form_data, hidden: true}),
            h('p',
              'Account: ', {{ env.account_title(src) | tojson }},
              h('br'),
              'Balance: ', `${balance.GBP.toFixed(2)} + ${total.value.toFixed(2)} = ${(balance.GBP + total.value).toFixed(2)}`,
            ),
            h('p', h('button.pure-button.pure-button-primary', {type: 'submit', disabled: !submit_ok.value}, 'Import')),
            h('v-stack', h(TransactionList))
        ]
    }

    const accountSelector = node2component(document.querySelector('#accountSelector').content.querySelector('select'))
    registerPreactData(tranForm)
    initPreactData()
</script>

{% endblock %}
